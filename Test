package com.epay.transaction.repository;

import com.epay.transaction.entity.MerchantOrderPayment;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

/**
 * Class Name:PaymentInitiation
 * *
 * Description:
 * *
 * Author:V1014352(Ranjan Kumar)
 * <p>
 * Copyright (c) 2024 [State Bank of India]
 * All right reserved
 * *
 * Version:1.0
 */

@Repository
public interface MerchantOrderPaymentRepository extends JpaRepository<MerchantOrderPayment, String> {

    Optional<MerchantOrderPayment> findByAtrnNumber(String atrn);

    Optional<MerchantOrderPayment> findBymIdAndAtrnNumber(String mId, String atrnNumber);

    @Query(value = "SELECT COUNT(t) FROM MerchantOrderPayment t WHERE t.sbiOrderRefNumber =:sbiOrderRefNumber AND t.transactionStatus IN (:statusList)")
    int countBySbiOrderRefNumberAndTransactionStatusIn(String sbiOrderRefNumber, List<String> statusList);

    @Query(value = "SELECT COUNT(*),NVL(SUM(MOP.DEBIT_AMT),0) FROM CARD_PAYMENT_SUMMARY CPS,MERCHANT_ORDER_PAYMENTS MOP WHERE CPS.ATRN_NUM = MOP.ATRN_NUM and MOP.TRANSACTION_STATUS = 'SUCCESS' and CARD_HASH =:altHash and TRUNC((TO_DATE('1970-01-01 00:00:00', 'yyyy-mm-dd hh24:mi:ss') + CPS.CREATED_DATE_NUM/1000/86400)) = TRUNC(SYSDATE)", nativeQuery = true)
    Object[] cardPaymentSummary(String altHash);

    Page<MerchantOrderPayment> findAll(Specification<MerchantOrderPayment> specification, Pageable pageable);

}
